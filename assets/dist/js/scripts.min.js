class WheelOfFortune{constructor(t){this.canvas=t.canvas,this.ctx=this.canvas.getContext("2d"),this.center=this.canvas.width/2,this.radius=this.center,this.sections=t.sections||[],this.ajaxUrl=t.ajaxUrl,this.nonce=t.nonce,this.resultEl=t.resultEl,this.phone=t.phone||"",this.anglePerSection=2*Math.PI/this.sections.length,this.currentAngle=0,this.spinning=!1,this.continuousSpinId=null,this.pointerDistance=50,this.pointerSize=28,this.modal=document.getElementById("wof-modal"),this.delay=1e3,this.init()}init(){this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas()),window.addEventListener("DOMContentLoaded",()=>{this.showAfterDelay(),this.bindClose()}),this.spinBtn&&this.spinBtn.addEventListener("click",()=>this.handleSpin())}setSpinButton(t){this.spinBtn=t,this.spinBtn.addEventListener("click",()=>this.handleSpin())}showAfterDelay(){this.getCookie("wof_last_win")||setTimeout(()=>{this.modal.classList.remove("wof-hidden")},this.delay)}bindClose(){var t=this.modal.querySelector(".wheel-form .close");t&&t.addEventListener("click",()=>{this.modal.classList.add("wof-hidden")})}drawWheel(){let i=window.innerWidth<=768,s=(console.log(i),this.ctx),a=this.center,h=this.radius;s.clearRect(0,0,this.canvas.width,this.canvas.height),this.sections.forEach((t,e)=>{var n=this.currentAngle+e*this.anglePerSection-Math.PI/2,i=n+this.anglePerSection,n=(s.beginPath(),s.moveTo(a,a),s.arc(a,a,h,n,i),e%2==0?"#fff":"rgba(104, 91, 199, 1)");s.fillStyle=n,s.fill()}),s.lineWidth=25,s.strokeStyle="rgba(238, 66, 133, 1)",s.beginPath(),s.arc(a,a,h,0,2*Math.PI),s.stroke(),this.sections.forEach((t,e)=>{var n=this.currentAngle+e*this.anglePerSection-Math.PI/2,n=(s.save(),s.translate(a,a),s.rotate(n+this.anglePerSection/2),s.textAlign="center",s.textBaseline="middle",console.log(t),"discount"===t.type?s.font=i?"bold 22px Rubik, sans-serif":"bold 28px Rubik, sans-serif":s.font=i?"700 10px Rubik, sans-serif":"700 12.71px Rubik, sans-serif",s.fillStyle=e%2==0?"rgba(104, 91, 199, 1)":"#fff",h-100),e=i?h-90+25:h-90+15;this.wrapText(s,t.label.toUpperCase(),e,0,n,14),s.restore()}),s.beginPath(),s.arc(a,a,50,0,2*Math.PI),s.fillStyle="#fff",s.fill(),s.lineWidth=11,s.strokeStyle="rgba(238, 66, 133, 1)",s.stroke(),s.beginPath(),s.moveTo(a+this.pointerDistance,a-this.pointerSize/2),s.lineTo(a+this.pointerDistance+this.pointerSize,a),s.lineTo(a+this.pointerDistance,a+this.pointerSize/2),s.closePath(),s.fillStyle="rgba(238, 66, 133, 1)",s.fill()}resizeCanvas(){var t=this.canvas.parentElement;t&&(t=Math.min(t.offsetWidth,.5*window.innerHeight),this.canvas.width=t,this.canvas.height=t,this.center=t/2,this.radius=this.center,this.anglePerSection=2*Math.PI/this.sections.length,this.drawWheel())}wrapText(e,t,n,i,s,a){var h=t.split(" ");let o="";var l=[];for(let t=0;t<h.length;t++){var r=o+h[t]+" ",c=e.measureText(r).width;o=s<c&&0<t?(l.push(o),h[t]+" "):r}l.push(o);var d=i-l.length*a/2+a/2;for(let t=0;t<l.length;t++)e.fillText(l[t].trim(),n,d+t*a)}setPhoneInput(t){this.phoneInput=t,"undefined"!=typeof Inputmask&&Inputmask({mask:"(099)9999999"}).mask(this.phoneInput),this.phoneInput.addEventListener("input",()=>{this.resultEl&&(this.resultEl.textContent="")})}getPhoneValue(){return this.phoneInput?.value?.replace(/\D/g,"")||""}isValidPhone(t){return/^0\d{9}$/.test(t)}setCookie(t,e,n){n=new Date(Date.now()+864e5*n).toUTCString();document.cookie=t+"="+encodeURIComponent(e)+"; expires="+n+"; path=/"}getCookie(t){t=("; "+document.cookie).split(`; ${t}=`);if(2===t.length)return t.pop().split(";").shift()}handleSpin(){var t;this.spinning||(t=this.getPhoneValue(),this.isValidPhone(t)?(this.resultEl&&(this.resultEl.textContent="Зачекайте..."),this.spinning=!0,fetch(this.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"wof_spin",nonce:this.nonce,phone:t})}).then(t=>t.json()).then(t=>{if(!t.success)throw new Error(t.data?.message||"Серверна помилка.");this.resultEl&&(this.resultEl.textContent="");let e=t.data.result;var n=this.sections.findIndex(t=>t.id===e);if(-1===n)throw new Error("Некоректний ID призу.");this.animateFinalSpin(n);let i=this;setTimeout(function(){t.data.html&&(i.modal.innerHTML=t.data.html)},6e3)}).catch(t=>{this.spinning=!1,this.resultEl&&(this.resultEl.textContent=t.message||"Помилка при обертанні.")})):this.resultEl&&(this.resultEl.textContent="Введіть коректний номер у форматі 0991234567"))}startContinuousSpin(){let t=this.currentAngle,e=()=>{t+=.3,this.currentAngle=t%(2*Math.PI),this.drawWheel(),this.continuousSpinId=requestAnimationFrame(e)};e()}setPrizeProductPrice(){}stopContinuousSpin(){this.continuousSpinId&&(cancelAnimationFrame(this.continuousSpinId),this.continuousSpinId=null)}animateFinalSpin(n){var t=Math.PI/2-n*this.anglePerSection-this.anglePerSection/2;let i=10*Math.PI+t,s=null,a=this.currentAngle,h=t=>{var t=t-(s=s||t),t=Math.min(t/5e3,1),e=1-Math.pow(1-t,3);this.currentAngle=a+(i-a)*e,this.drawWheel(),t<1?requestAnimationFrame(h):(this.currentAngle%=2*Math.PI,this.spinning=!1,console.log("🎉 You won: "+this.sections[n].label),this.setCookie("wof_last_win",JSON.stringify({prize:this.sections[n].label,date:(new Date).toISOString()}),7),"function"==typeof Cart&&"function"==typeof(e=new Cart).updateCartInformation&&e.updateCartInformation())};requestAnimationFrame(h)}}let wheel=new WheelOfFortune({canvas:document.getElementById("wheel"),sections:WOF_JS.wheelItems.map((t,e)=>({id:e,label:t.text,type:t.type})),ajaxUrl:WOF_JS.ajaxUrl,nonce:WOF_JS.nonce,resultEl:document.getElementById("result")});document.getElementById("wheel-phone").addEventListener("input",()=>{var t=document.getElementById("result");t&&(t.textContent="")}),wheel.setSpinButton(document.getElementById("spinBtn")),wheel.setPhoneInput(document.getElementById("wheel-phone"));